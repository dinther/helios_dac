<!DOCTYPE html>
<html lang="en" class="nowhitespace">
	<head>
		<meta name="description" content="Web USB">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Web USB</title>
	</head>
	<body>
		<div id="container">
			<button id="connectBtn">Connect Helios Laser DAC</button>
            <button id="disconnectBtn" disabled>Disconnect All</button>
			<button id="playBtn" disabled>Play</button>
			<button id="stopBtn" disabled>Stop</button>
            <div id="statusLogElm"></div>
		</div>
		<script type="module">           
            import * as Helios from './helios_dac.js';
			var HELIOS = Helios;
			window.HELIOS = HELIOS;
			const PPS = 35000;
			const FLAGS = HELIOS.HELIOS_FLAGS_DEFAULT;
			const MAX_GET_STATUS_RETRIES = 512;



			let statusLogElm;
			let connectBtn;
			let disconnectBtn;
			let playBtn;
			let stopBtn;
			let heliosDacManager;
			let frames;
			let stopAnimation = false;
			//let scanLine = new ScanLine(2000, 500, 5, 5);

			async function getHeliosDevices(){
				statusLogElm.innerHTML = '';
				let heliosDevices = [];
				try{
					heliosDevices = await HELIOS.getHeliosDevices();				
					heliosDevices.forEach( async (device, index)=>{
						device.onFrame = async (device)=>{
							console.log('start onFrame');
							let frame = [];
							let y = Math.floor(Date.now()%2000 / 2000 * 4095);
							for(let i=0; i<15; i++) frame.push(new HELIOS.HeliosPoint(0, y, 0, 0, 0));
							for(let i=0; i<256; i++) frame.push(new HELIOS.HeliosPoint(i*16, y, 255-i, i, 0));

							await device.sendFrame(PPS, FLAGS, frame, frame.length);
							console.log('end onFrame');
						};
						await device.connect();
						statusLogElm.innerHTML +=
							'Device [' + index + ' - ' + device.name +'] ' +
							'Connected to: ' + device.productName +
							' manufacturer: ' + device.manufacturerName +
							' firmware version: ' + device.firmwareVersion +
							'<br>';
					});
					disconnectBtn.disabled = false;
					playBtn.disabled = false;
				} catch (error){
					console.log('navigator.usb.requestDevice cancelled by user');
				}
				return heliosDevices;
			}

			document.addEventListener('DOMContentLoaded', async () => {
				statusLogElm = document.getElementById('statusLogElm');
				connectBtn = document.getElementById('connectBtn');
				disconnectBtn = document.getElementById('disconnectBtn');
				playBtn = document.getElementById('playBtn');
				stopBtn = document.getElementById('stopBtn');
				connectBtn.addEventListener('click', async () => {
					try{
						await HELIOS.connectHeliosDevice();
						heliosDevices = await getHeliosDevices();
					} catch (error){
						console.log('navigator.usb.requestDevice cancelled by user');
					}
				});

				playBtn.addEventListener('click', async () => {
					heliosDevices.forEach( async (device, index)=>{
						device.start();
					});
					statusLogElm.innerHTML += 'Starting devices.<br>';
					playBtn.disabled = true;
					stopBtn.disabled = false;
				});

				//  Stops animation cycle
				stopBtn.addEventListener('click', async () => {
					try{
						heliosDevices.forEach( async (device, index)=>{
							device.stop();
						});
						statusLogElm.innerHTML += 'Stopping devices.<br>';
						stopBtn.disabled = true;
						playBtn.disabled = false;
					} catch (err){
						console.log(err);
					}					
				});
				
				disconnectBtn.addEventListener('click', async () => {
					try{
						//await heliosDacManager.closeDevices();
						for (let j = 0; j < heliosDevices.length; j++) {
							await heliosDevices[j].close();
						}
						console.log("Devices closed.");
						statusLogElm.innerHTML += 'All devices disconnected<br>';
						stopBtn.disabled = true;
						disconnectBtn.disabled = true;
						playBtn.disabled = true;
					} catch (err){
						console.log(err);
					}
				});

				var heliosDevices = await getHeliosDevices();
				console.log(heliosDevices);
			});			
		</script>
	</body>
</html>
