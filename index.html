<!DOCTYPE html>
<html lang="en" class="nowhitespace">
	<head>
		<meta name="description" content="Web USB">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Web USB</title>
	</head>
	<body>
		<div id="container">
			<button id="connectBtn">Connect Helios Laser DAC</button>
            <button id="disconnectBtn" disabled>Disconnect All</button>
			<button id="playBtn" disabled>Play</button>
			<button id="stopBtn" disabled>Stop</button>
            <div id="statusLogElm"></div>
			<div id="colors"></div>
		</div>
		<script type="module">           
            import {HeliosPoint, connectHeliosDevice, getHeliosDevices, HeliosDevice} from './helios_dac.js';

			let statusLogElm;
			let connectBtn;
			let disconnectBtn;
			let playBtn;
			let stopBtn;

			function easeOutBounce(x){
				const n1 = 7.5625;
				const d1 = 2.75;
				if (x < 1 / d1) {
					return n1 * x * x;
				} else if (x < 2 / d1) {
					return n1 * (x -= 1.5 / d1) * x + 0.75;
				} else if (x < 2.5 / d1) {
					return n1 * (x -= 2.25 / d1) * x + 0.9375;
				} else {
					return n1 * (x -= 2.625 / d1) * x + 0.984375;
				}
			}

			console.log(colors);
			async function getHeliosDevicesUI(){
				statusLogElm.innerHTML = '';
				let heliosDevices = [];
				try{
					heliosDevices = await getHeliosDevices();		
					heliosDevices.forEach( async (device, index)=>{
						device.onFrame = async (device)=>{
							let frame = [];
							let y = Math.floor(Date.now()%8000 / 8000 * 2048);
							if (y > 1648){
								y = Math.floor(1648 - easeOutBounce((y-1648)/400) * 1648);
							}
							for(let i=0; i<15; i++) frame.push(new HeliosPoint(0, y+2048, 0, 0, 0));
							for(let i=0; i<256; i++) frame.push(new HeliosPoint(i*16, y+2048, 255-i, (i<128)?i : 256-i, (i<200)? 0:(i-200)*4));	
							await device.sendFrame(frame, 30000);
						};
						await device.connect();
						statusLogElm.innerHTML +=
							'Device [' + index + ' - ' + device.name +'] ' +
							'Connected to: ' + device.productName +
							' manufacturer: ' + device.manufacturerName +
							' firmware version: ' + device.firmwareVersion +
							'<br>';
					});
					disconnectBtn.disabled = false;
					playBtn.disabled = false;
				} catch (error){
					console.log('getHeliosDevicesUI', error);
				}
				return heliosDevices;
			}

			document.addEventListener('DOMContentLoaded', async () => {
				statusLogElm = document.getElementById('statusLogElm');
				connectBtn = document.getElementById('connectBtn');
				disconnectBtn = document.getElementById('disconnectBtn');
				playBtn = document.getElementById('playBtn');
				stopBtn = document.getElementById('stopBtn');
				connectBtn.addEventListener('click', async () => {
					try{
						await connectHeliosDevice();
						heliosDevices = await getHeliosDevicesUI();
					} catch (error){
						console.log('connectHeliosDevice', error);
					}
				});

				playBtn.addEventListener('click', async () => {
					heliosDevices.forEach( async (device, index)=>{
						device.start();
					});
					statusLogElm.innerHTML += 'Starting devices.<br>';
					playBtn.disabled = true;
					stopBtn.disabled = false;
				});

				//  Stops animation cycle
				stopBtn.addEventListener('click', async () => {
					try{
						heliosDevices.forEach( async (device, index)=>{
							device.stop();
						});
						statusLogElm.innerHTML += 'Stopping devices.<br>';
						stopBtn.disabled = true;
						playBtn.disabled = false;
					} catch (err){
						console.log(err);
					}					
				});
				
				disconnectBtn.addEventListener('click', async () => {
					try{
						//await heliosDacManager.closeDevices();
						for (let j = 0; j < heliosDevices.length; j++) {
							await heliosDevices[j].close();
						}
						console.log("Devices closed.");
						statusLogElm.innerHTML += 'All devices disconnected<br>';
						stopBtn.disabled = true;
						disconnectBtn.disabled = true;
						playBtn.disabled = true;
					} catch (err){
						console.log(err);
					}
				});

				let heliosDevices = await getHeliosDevicesUI();
				window.heliosDevices = heliosDevices;
			});			
		</script>
	</body>
</html>
