<!DOCTYPE html>
<html lang="en" class="nowhitespace">
	<head>
		<meta name="description" content="Web USB">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Web USB</title>
	</head>
	<body>
		<div id="container">
			<button id="connectBtn">Connect Helios Laser DAC</button>
            <button id="disconnectBtn" disabled>Disconnect All</button>
			<button id="playBtn" disabled>Play</button>
			<button id="stopBtn" disabled>Stop</button>
            <div id="statusLogElm"></div>
		</div>
		<script type="module">           
            import * as Helios from './helios_dac.js';
			var HELIOS = Helios;
			window.HELIOS = HELIOS;
			const POINTS_PER_FRAME = 400;
			const PPS = 35000;
			const FLAGS = HELIOS.HELIOS_FLAGS_DEFAULT;
			const MAX_GET_STATUS_RETRIES = 512;

			class ScanLine {
				#duration;
				#startDwell;
				#endDwell;
				#totalPoints;
				#odd = false;
				constructor(duration=2000, totalPoints=500, startDwell=15, endDwell=15){
					this.#duration = duration;
					this.#totalPoints = totalPoints;
					this.#startDwell = startDwell;
					this.#endDwell = endDwell;
				}
				getFrame(timeStamp){
					let f = timeStamp%this.#duration / this.#duration;
					this.#odd = !this.#odd;
					let y = Math.floor(f * 4095);
					let frame = [];
					for (let db = 0; db < this.#startDwell; db++) {
						let x = this.#odd? 4095 : 0;
						let point = new HELIOS.HeliosPoint(x, y, 0, 0, 0);
						frame.push(point);
					}
					let totalPoints = this.#totalPoints - this.#startDwell - this.#endDwell;
					for (let j = 0; j < totalPoints; j++) {
							let x = j/this.#totalPoints*4095;
							x = this.#odd? 4095 - x : x;
							const point = new HELIOS.HeliosPoint(x, y, Math.floor(timeStamp*1.2%255), Math.floor(timeStamp%255), Math.floor(timeStamp*1.7%255));
							frame.push(point);
					}
					for (let da = 0; da < this.#endDwell; da++) {
						let x = this.#odd? 4095 : 0;
						let point = new HELIOS.HeliosPoint(x, y, 0, 0, 0, 0);
						frame.push(point);
					}
					return frame;
				}
			}

			let statusLogElm;
			let connectBtn;
			let disconnectBtn;
			let playBtn;
			let stopBtn;
			let heliosDacManager;
			let frames;
			let stopAnimation = false;
			let scanLine = new ScanLine(2000, 500, 5, 5);

			async function getHeliosDevices(){
				statusLogElm.innerHTML = '';
				let heliosDevices = [];
				try{
					heliosDevices = await HELIOS.getHeliosDevices();				
					heliosDevices.forEach( async (device, index)=>{
						device.onFrame = async (device)=>{
							console.log('start onFrame');
							//let frame = scanLine.getFrame(Date.now()); 

							let frame = [];
							for(let i=0; i<15; i++) frame.push(new HELIOS.HeliosPoint(0, 2048, 0, 0, 0));
							for(let i=0; i<256; i++) frame.push(new HELIOS.HeliosPoint(i*16, 2048, 255-i, i, 0));

							await device.sendFrame(PPS, FLAGS, frame, frame.length);
							console.log('end onFrame');
						};
						await device.connect();
						statusLogElm.innerHTML +=
							'Device [' + index + ' - ' + device.name +'] ' +
							'Connected to: ' + device.productName +
							' manufacturer: ' + device.manufacturerName +
							' firmware version: ' + device.firmwareVersion +
							'<br>';
					});
					disconnectBtn.disabled = false;
					playBtn.disabled = false;
				} catch (error){
					console.log('navigator.usb.requestDevice cancelled by user');
				}
				return heliosDevices;
			}

			document.addEventListener('DOMContentLoaded', async () => {
				statusLogElm = document.getElementById('statusLogElm');
				connectBtn = document.getElementById('connectBtn');
				disconnectBtn = document.getElementById('disconnectBtn');
				playBtn = document.getElementById('playBtn');
				stopBtn = document.getElementById('stopBtn');
				connectBtn.addEventListener('click', async () => {
					try{
						await HELIOS.connectHeliosDevice();
						heliosDevices = await getHeliosDevices();
					} catch (error){
						console.log('navigator.usb.requestDevice cancelled by user');
					}
				});

				playBtn.addEventListener('click', async () => {
					heliosDevices.forEach( async (device, index)=>{
						device.start();
					});
					statusLogElm.innerHTML += 'Starting devices.<br>';
					playBtn.disabled = true;
					stopBtn.disabled = false;
				});

				//  Stops animation cycle
				stopBtn.addEventListener('click', async () => {
					try{
						heliosDevices.forEach( async (device, index)=>{
							device.stop();
						});
						statusLogElm.innerHTML += 'Stopping devices.<br>';
						stopBtn.disabled = true;
						playBtn.disabled = false;
					} catch (err){
						console.log(err);
					}					
				});
				
				disconnectBtn.addEventListener('click', async () => {
					try{
						//await heliosDacManager.closeDevices();
						for (let j = 0; j < heliosDevices.length; j++) {
							await heliosDevices[j].close();
						}
						console.log("Devices closed.");
						statusLogElm.innerHTML += 'All devices disconnected<br>';
						stopBtn.disabled = true;
						disconnectBtn.disabled = true;
						playBtn.disabled = true;
					} catch (err){
						console.log(err);
					}
				});

				var heliosDevices = await getHeliosDevices();
				console.log(heliosDevices);
			});

			var bouncingLine = function (timestamp, dataObject) {
				let r = 30;
				let hr = r/2;
				if (dataObject.startX === undefined){
					dataObject.dwell = 15;
					dataObject.startX = Math.random()*4095;
					dataObject.startY = Math.random()*4095;
					dataObject.endX = Math.random()*4095;
					dataObject.endY = Math.random()*4095;
					dataObject.deltaStartX = Math.random()*r-hr;
					dataObject.deltaStartY = Math.random()*r, hr;
					dataObject.deltaEndX = Math.random()*r, hr;
					dataObject.deltaEndY = Math.random()*r, hr;
					dataObject.r = Math.random()*255;
					dataObject.g = Math.random()*255;
					dataObject.b = Math.random()*255;
				}
				// move a bit
				dataObject.startX += dataObject.deltaStartX;
				dataObject.startY += dataObject.deltaStartY;
				dataObject.endX += dataObject.deltaEndX;
				dataObject.endY += dataObject.deltaEndY;

				if(dataObject.startX < 0) {
					dataObject.deltaStartX = Math.random()*hr;
					dataObject.r = Math.random()*255;
					dataObject.g = Math.random()*255;
					dataObject.b = Math.random()*255;
				}
				if(dataObject.startX > 4095){
					dataObject.deltaStartX = Math.random()*-hr
					dataObject.r = Math.random()*255;
					dataObject.g = Math.random()*255;
					dataObject.b = Math.random()*255;
				}
				if(dataObject.startY < 0){
					dataObject.deltaStartY = Math.random()*hr;
					dataObject.r = Math.random()*255;
					dataObject.g = Math.random()*255;
					dataObject.b = Math.random()*255;
				}
				if(dataObject.startY > 4095){
					dataObject.deltaStartY = Math.random()*-hr;
					dataObject.r = Math.random()*255;
					dataObject.g = Math.random()*255;
					dataObject.b = Math.random()*255;
				}
				if(dataObject.endX < 0){
					dataObject.deltaEndX = Math.random()*hr;
					dataObject.r = Math.random()*255;
					dataObject.g = Math.random()*255;
					dataObject.b = Math.random()*255;
				}
				if(dataObject.endX > 4095){
					dataObject.deltaEndX = Math.random()*-hr;
					dataObject.b = Math.random()*255;
				}
				if(dataObject.endY < 0){
					dataObject.deltaEndY = Math.random()*hr;
					dataObject.r = Math.random()*255;
					dataObject.g = Math.random()*255;
					dataObject.b = Math.random()*255;
				}
				if(dataObject.endY > 4095){
					dataObject.deltaEndY = Math.random()*-hr;
					dataObject.r = Math.random()*255;
					dataObject.g = Math.random()*255;
					dataObject.b = Math.random()*255;
				}

				let dx = (dataObject.endX - dataObject.startX)/POINTS_PER_FRAME;
				let dy = (dataObject.endY - dataObject.startY)/POINTS_PER_FRAME;
				let frame = [];
				let totalPoints = POINTS_PER_FRAME - dataObject.dwell - dataObject.dwell;
				for (let db = 0; db < dataObject.dwell; db++) {
					let point = new HELIOS.HeliosPoint(Math.floor(dataObject.startX), Math.floor(dataObject.startY), 0, 0, 0);
					frame.push(point);
				}
				for (let j = 0; j < totalPoints; j++) {
					let point = new HELIOS.HeliosPoint(Math.floor(dataObject.startX + (dx*j)), Math.floor(dataObject.startY+(dy*j)), Math.floor(dataObject.r), Math.floor(dataObject.g), Math.floor(dataObject.b));
					frame.push(point);
				}
				for (let da = 0; da < dataObject.dwell; da++) {
					let point = new HELIOS.HeliosPoint(Math.floor(dataObject.endX), Math.floor(dataObject.endY), 0, 0, 0);
					frame.push(point);
				}
				return frame;
			}
		</script>
	</body>
</html>
